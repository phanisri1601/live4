
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Setup Your Chatbot</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 10% -10%, #0b122a 0%, rgba(2,6,23,0) 60%),
                  radial-gradient(1200px 800px at 110% 10%, #0f1b44 0%, rgba(2,6,23,0) 50%),
                  linear-gradient(120deg, #0b1020 0%, #0b122a 100%);
      color: #e2e8f0;
      min-height: 100vh;
      margin: 0;
      padding: 0;
    }
    body.light {
      background: radial-gradient(1200px 800px at 10% -10%, #ffffff 0%, rgba(255,255,255,0) 60%),
                  radial-gradient(1200px 800px at 110% 10%, #ffffff 0%, rgba(255,255,255,0) 50%),
                  linear-gradient(120deg, #f8fafc 0%, #ffffff 100%);
      color: #0f172a;
    }
    /* Force all text to dark in Light theme */
    body.light :where(h1,h2,h3,h4,h5,h6,p,span,div,li,small,strong,em,label,a,button,th,td,caption,figcaption){
      color:#0f172a !important;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .card {
      background: linear-gradient(180deg, rgba(2,6,23,.75), rgba(2,6,23,.45));
      border: 1px solid transparent;
      border-radius: 16px;
      box-shadow: 0 16px 50px rgba(2,6,23,.5);
      padding: 32px;
      margin-bottom: 24px;
      backdrop-filter: blur(8px);
      color: #e2e8f0;
    }
    body.light .card { background:#ffffff; border:1px solid rgba(0,0,0,.12); color:#0f172a; box-shadow:0 8px 24px rgba(0,0,0,.08); }
    
    h1 { margin: 0 0 8px; font-size: 28px; color: #e2e8f0; font-weight: 700; }
    body.light h1 { color:#0f172a; }
    
    h2 {
      margin: 0 0 20px;
      font-size: 20px;
      color: #e5e7eb;
      font-weight: 600;
    }
    body.light h2 { color:#0f172a; }
    
    .sub {
      color: #ffffff;
      margin: 0 0 24px;
      font-size: 16px;
    }
    body.light .sub { color:#475569; }
    
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-bottom: 24px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin: 0 0 8px;
      color: #e5e7eb;
      font-weight: 600;
      font-size: 14px;
    }
    body.light .form-group label { color:#0f172a; }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid rgba(148,163,184,.25);
      border-radius: 12px;
      font-size: 14px;
      outline: none;
      box-sizing: border-box;
      background: rgba(15,23,42,.6);
      color: #e2e8f0;
      backdrop-filter: blur(8px);
      transition: all 0.3s ease;
    }
    body.light .form-group input,
    body.light .form-group select,
    body.light .form-group textarea { background:#ffffff; color:#0f172a; border-color: rgba(0,0,0,.12); }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus { border-color: #60a5fa; box-shadow: 0 0 0 3px rgba(96,165,250,.15); }
    
    .form-group input::placeholder,
    .form-group textarea::placeholder {
      color: #9ca3af;
    }
    body.light .form-group input::placeholder,
    body.light .form-group textarea::placeholder { color:#64748b; }
    
    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }
    
    .file-upload { border: 2px dashed rgba(148,163,184,.35); border-radius: 12px; padding: 32px; text-align: center; background: rgba(2,6,23,.35); cursor: pointer; transition: all 0.3s ease; backdrop-filter: blur(8px); }
    body.light .file-upload { background:#ffffff; border-color: rgba(0,0,0,.12); }
    
    .file-upload:hover { border-color:#60a5fa; background: rgba(15,23,42,.5); transform: translateY(-2px); box-shadow: 0 12px 30px rgba(6,182,212,.18); }
    
    .file-upload.dragover {
      border-color: #a855f7;
      background: rgba(168, 85, 247, 0.1);
    }
    
    .file-list {
      margin-top: 20px;
    }
    
    .file-item { display:flex; justify-content:space-between; align-items:center; padding:12px 16px; background: rgba(15,23,42,.55); border-radius: 10px; margin-bottom: 8px; border:1px solid rgba(148,163,184,.25); }
    body.light .file-item { background:#ffffff; border-color: rgba(0,0,0,.12); color:#0f172a; }
    
    .file-item .file-name {
      font-weight: 500;
      color: #e5e7eb;
    }
    
    .file-item .file-size {
      color: #9ca3af;
      font-size: 12px;
    }
    
    .file-item .remove-btn {
      color: #ef4444;
      cursor: pointer;
      font-weight: bold;
      font-size: 18px;
    }
    
    .btn { padding: 12px 16px; border: 2px solid rgba(148,163,184,.25); border-radius: 10px; background: rgba(15,23,42,.6); color: #e2e8f0; cursor: pointer; font-weight: 700; transition: all 0.3s ease; backdrop-filter: blur(8px); }
    body.light .btn { background:#ffffff; color:#0f172a; border-color: rgba(0,0,0,.12); }
    
    .btn-primary { background: linear-gradient(135deg,#6366f1 0%,#3b82f6 60%,#06b6d4 120%); color:#fff; border:none; box-shadow:0 12px 30px rgba(6,182,212,.25); }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(168, 85, 247, 0.4);
    }
    
    .btn-secondary {
      background: rgba(107, 114, 128, 0.8);
      color: #ffffff;
      border: none;
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
      color: #ffffff;
      border: none;
    }
    
    .ok {
      color: #10b981;
      font-size: 14px;
      font-weight: 500;
    }
    
    .err {
      color: #ef4444;
      font-size: 14px;
      font-weight: 500;
    }
    
    .preview-section {
      margin-top: 24px;
      padding: 24px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      border: 1px solid rgba(76, 29, 149, 0.2);
      backdrop-filter: blur(10px);
    }
    
    .color-palette {
      display: flex;
      gap: 12px;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    .color-row { display:flex; flex-wrap:wrap; gap:12px; align-items:center; }
    .color-advanced { display:flex; align-items:center; gap:10px; background: rgba(0,0,0,0.2); border:1px solid rgba(76,29,149,0.3); padding:10px 12px; border-radius:10px; }
    .color-advanced input[type="color"]{ width:42px; height:42px; border:none; background:transparent; padding:0; cursor:pointer; }
    .hex-input{ width:110px; padding:10px 12px; border:2px solid rgba(76,29,149,0.3); border-radius:8px; background:rgba(0,0,0,0.3); color:#fff; }
    
    .color-option {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      cursor: pointer;
      border: 3px solid transparent;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    .color-option:hover {
      transform: scale(1.1);
    }
    
    .color-option.selected {
      border-color: #a855f7;
      box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.3);
    }
    
    .industry-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 12px;
    }
    
    .industry-tag {
      padding: 8px 16px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(76, 29, 149, 0.3);
      border-radius: 25px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      color: #e5e7eb;
      transition: all 0.3s ease;
    }
    
    .industry-tag:hover {
      background: rgba(168, 85, 247, 0.2);
      border-color: #a855f7;
    }
    
    .industry-tag.selected {
      background: linear-gradient(135deg, #4c1d95 0%, #a855f7 100%);
      color: #ffffff;
      border-color: #a855f7;
    }
    
    .personality-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 16px;
      margin-top: 12px;
    }
    
    .personality-option {
      padding: 20px;
      border: 2px solid rgba(76, 29, 149, 0.3);
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      background: rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(10px);
    }
    
    .personality-option:hover {
      border-color: #a855f7;
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(168, 85, 247, 0.2);
    }
    
    .personality-option.selected {
      border-color: #a855f7;
      background: linear-gradient(135deg, rgba(76, 29, 149, 0.3) 0%, rgba(168, 85, 247, 0.1) 100%);
    }
    
    .personality-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }
    
    .personality-emoji {
      font-size: 28px;
    }
    
    .personality-name {
      font-weight: 600;
      color: #ffffff;
      font-size: 16px;
    }
    
    .personality-desc {
      color: #ffffff;
      font-size: 14px;
      line-height: 1.5;
      margin: 0;
    }
    
    .response-length-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      margin-top: 12px;
    }
    
    .response-option {
      padding: 20px;
      border: 2px solid rgba(76, 29, 149, 0.3);
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      background: rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(10px);
    }
    
    .response-option:hover {
      border-color: #a855f7;
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(168, 85, 247, 0.2);
    }
    
    .response-option.selected {
      border-color: #a855f7;
      background: linear-gradient(135deg, rgba(76, 29, 149, 0.3) 0%, rgba(168, 85, 247, 0.1) 100%);
    }
    
    .response-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }
    
    .response-emoji {
      font-size: 24px;
    }
    
    .response-name {
      font-weight: 600;
      color: #ffffff;
      font-size: 15px;
    }
    
    .response-desc {
      color: #ffffff;
      font-size: 13px;
      line-height: 1.4;
      margin: 0;
    }

    /* Bot avatar selector */
    .avatar-grid{ display:flex; flex-wrap:wrap; gap:12px; margin-top:12px; }
    .avatar-item{ width:60px; height:60px; border-radius:50%; overflow:hidden; border:3px solid rgba(76,29,149,0.3); cursor:pointer; transition:all .3s ease; background:rgba(0,0,0,0.3); display:flex; align-items:center; justify-content:center; position:relative; }
    .avatar-item img{ width:100%; height:100%; object-fit:cover; border-radius:50%; animation: ai-float 3.2s ease-in-out infinite alternate; will-change: transform; }
    .avatar-item:hover{ transform: translateY(-3px) scale(1.05); border-color:#a855f7; box-shadow:0 8px 25px rgba(168,85,247,0.3); }
    .avatar-item.selected{ border-color:#a855f7; box-shadow:0 0 0 3px rgba(168,85,247,.4), 0 4px 15px rgba(168,85,247,0.2); }
    .avatar-item.selected::after{ content:'✓'; position:absolute; top:-5px; right:-5px; background:#a855f7; color:white; border-radius:50%; width:20px; height:20px; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:bold; }
    @keyframes ai-float { from { transform: translateY(0); } to { transform: translateY(-4px); } }
    
    .row {
      display: flex;
      gap: 16px;
      align-items: center;
      justify-content: flex-end;
      margin-top: 32px;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 4px;
      overflow: hidden;
      margin: 12px 0;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(135deg, #4c1d95 0%, #a855f7 100%);
      transition: width 0.3s ease;
    }
    
    .section-divider {
      height: 1px;
      background: linear-gradient(90deg, transparent 0%, rgba(76, 29, 149, 0.5) 50%, transparent 100%);
      margin: 32px 0;
    }

    /* Wizard stepper */
    .stepper { display:flex; align-items:center; gap:10px; margin: 0 0 16px; }
    .step-dot { width:10px; height:10px; border-radius:50%; background:#374151; opacity:.6; }
    .step-dot.active { background:#a855f7; opacity:1; box-shadow:0 0 0 3px rgba(168,85,247,.25); }
    .wizard-actions { display:flex; justify-content:space-between; gap:10px; margin-top:16px; }
    .btn.ghost { background: transparent; border:1px solid rgba(255,255,255,.25); }
    
    @media (max-width: 768px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
      .container {
        padding: 16px;
      }
      .card {
        padding: 24px;
      }
      .personality-options {
        grid-template-columns: 1fr;
      }
      .response-length-options {
        grid-template-columns: 1fr;
      }
      .row {
        flex-direction: column;
        align-items: stretch;
      }
    }
  </style>
  <script>
    (function(){
      try{
        var theme = localStorage.getItem('dash_theme') || 'dark';
        if(theme === 'light'){
          document.addEventListener('DOMContentLoaded', function(){ document.body.classList.add('light'); });
        }
      }catch(_){ }
    })();
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
  <script>
    // Stepper
    let currentStep = 1;
    function renderStepper(){
      document.querySelectorAll('[data-step]')?.forEach(function(section){
        const step = Number(section.getAttribute('data-step'));
        section.style.display = (step === currentStep) ? 'block' : 'none';
      });
      document.querySelectorAll('.step-dot')?.forEach(function(dot){
        const s = Number(dot.getAttribute('data-step-index'));
        dot.classList.toggle('active', s === currentStep);
      });
      const prevBtn = document.getElementById('step-prev');
      const nextBtn = document.getElementById('step-next');
      const finishBtn = document.getElementById('step-finish');
      if (prevBtn) prevBtn.disabled = false; // allow going back to dashboard from any step
      if (nextBtn) nextBtn.style.display = (currentStep < 3 ? 'inline-flex' : 'none');
      if (finishBtn) finishBtn.style.display = (currentStep === 3 ? 'inline-flex' : 'none');
    }
    function gotoStep(delta){
      if(delta < 0 && currentStep === 1){
        try{
          var t = localStorage.getItem('token') || '';
          if(t){ window.location.href = '/dashboard?token=' + encodeURIComponent(t); }
          else { window.location.href = '/login'; }
        }catch(_){ window.location.href = '/login'; }
        return;
      }
      currentStep = Math.min(3, Math.max(1, currentStep + delta));
      renderStepper();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    let uploadedFiles = [];
    let companyData = {};
    // Flat-style human avatar SVG presets (head & shoulders, neutral bg)
    function toDataUrl(svg){ return 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg); }
    function flatAvatarSvg(opts){
      const gender = opts.gender || 'male';
      const mood = opts.mood || 'friendly';
      const primary = opts.primary || '#6366f1';
      const skin = opts.skin || (gender==='female' ? '#F7D8C8' : '#F2C7A6');
      const hair = opts.hair || (gender==='female' ? '#2B2A33' : '#1F2937');
      const shirt = opts.shirt || primary;

      // Features tuned for clearer, larger faces
      const mouth = (
        mood==='professional' ? 'M42 78 q18 6 36 0' :
        mood==='friendly' ? 'M42 79 q18 12 36 0' :
        mood==='humorous' ? 'M42 79 q18 13 36 0' :
        mood==='expert' ? 'M42 77 q18 5 36 0' :
        mood==='caring' ? 'M42 80 q18 14 36 0' :
        mood==='enthusiastic' ? 'M42 75 q18 18 36 0' :
        'M42 78 q18 9 36 0'
      );
      const browY = (mood==='professional' || mood==='expert') ? 54 : 52;
      const eyeDY = (mood==='enthusiastic') ? -1 : 0;
      const eyeLX = 52, eyeRX = 68, eyeY = 66 + eyeDY;
      const blush = (mood==='friendly' || mood==='caring' || mood==='humorous');

      // Hair shapes per gender
      const hairPath = (gender==='female'
        ? `<path d="M28 56 q32 -30 64 0 v18 q-8 24 -32 28 q-24 -4 -32 -24z" fill="${hair}"/>
           <path d="M36 56 q10 -12 24 -14 q14 2 24 14" fill="${hair}"/>`
        : `<path d="M36 54 q24 -18 48 0 v10 q-4 8 -10 10 q-14 6 -28 0 q-6 -2 -10 -10z" fill="${hair}"/>`);

      return `
<svg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 120 120'>
  <!-- neutral background circle and ring for visibility -->
  <circle cx='60' cy='60' r='54' fill='#0C1222'/>
  <circle cx='60' cy='60' r='48' fill='#0F172A' stroke='${primary}' stroke-opacity='.45' stroke-width='2'/>
  <!-- shoulders/shirt -->
  <path d='M28 102 q32 -22 64 0 v18 H28z' fill='${shirt}'/>
  <!-- neck -->
  <rect x='54' y='84' width='12' height='12' rx='4' fill='${skin}'/>
  <!-- face (bigger) -->
  <circle cx='60' cy='66' r='26' fill='${skin}'/>
  ${hairPath}
  <!-- eyes with whites and pupils -->
  <ellipse cx='${eyeLX}' cy='${eyeY}' rx='5' ry='3.6' fill='#FFFFFF'/>
  <ellipse cx='${eyeRX}' cy='${eyeY}' rx='5' ry='3.6' fill='#FFFFFF'/>
  <circle cx='${eyeLX}' cy='${eyeY}' r='1.8' fill='#111827'/>
  <circle cx='${eyeRX}' cy='${eyeY}' r='1.8' fill='#111827'/>
  <!-- brows -->
  <rect x='46' y='${browY}' width='12' height='2' rx='1' fill='#1f2937'/>
  <rect x='62' y='${browY}' width='12' height='2' rx='1' fill='#1f2937'/>
  <!-- simple nose -->
  <path d='M60 70 q0 6 0 6' stroke='#1f2937' stroke-width='2' stroke-linecap='round'/>
  <!-- mouth -->
  <path d='${mouth}' stroke='#1f2937' stroke-width='2' fill='none' stroke-linecap='round'/>
  ${blush ? "<circle cx='46' cy='76' r='3' fill='rgba(236,72,153,.45)'/><circle cx='74' cy='76' r='3' fill='rgba(236,72,153,.45)'/>" : ''}
</svg>`;
    }
    // Define 7 presets with gender and mood mapping
    const PRESETS = [
      // 1) Cowboy external image
      { external: '/assets/avatar-cowboy.png' },
      // 2) Doctor external image
      { external: '/assets/avatar-doctor.png' },
      { gender:'male', mood:'humorous', primary:'#f59e0b', hair:'#1F2937', skin:'#F1C7A3' },
      { gender:'male', mood:'expert', primary:'#60a5fa', hair:'#111827', skin:'#EFC9A6' },
      { gender:'female', mood:'caring', primary:'#ef4444', hair:'#3B2F2F', skin:'#F6D4C5' },
      // Slot 6 will be replaced with an external image
      { external: '/assets/avatar-smile.png' },
      { gender:'female', mood:'casual', primary:'#22c55e', hair:'#3B2F2F', skin:'#F6D4C5' }
    ];
    window.__avatars = PRESETS.map(p => p.external ? p.external : toDataUrl(flatAvatarSvg(p)));
    
    function ensureAuth(){
      const t=localStorage.getItem('token');
      if(!t){ location.href='/login'; return false; }
      return true;
    }
    
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    function handleFileSelect(event) {
      const files = Array.from(event.target.files);
      addFiles(files);
    }
    
    function handleDrop(event) {
      event.preventDefault();
      const dropZone = event.currentTarget;
      dropZone.classList.remove('dragover');
      
      const files = Array.from(event.dataTransfer.files);
      addFiles(files);
    }
    
    function handleDragOver(event) {
      event.preventDefault();
      event.currentTarget.classList.add('dragover');
    }
    
    function handleDragLeave(event) {
      event.currentTarget.classList.remove('dragover');
    }
    
    function addFiles(files) {
      files.forEach(file => {
        const allowedTypes = [
          'application/json',
          'text/plain',
          'application/pdf',
          'application/msword',
          'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
          'text/csv',
          'application/vnd.ms-excel',
          'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
        ];
        
        if (allowedTypes.includes(file.type) || file.name.endsWith('.txt') || file.name.endsWith('.json') || file.name.endsWith('.pdf') || file.name.endsWith('.doc') || file.name.endsWith('.docx')) {
          uploadedFiles.push({
            id: Date.now() + Math.random(),
            file: file,
            name: file.name,
            size: file.size,
            type: file.type
          });
        } else {
          alert(`File type not supported: ${file.name}`);
        }
      });
      updateFileList();
    }
    
    function removeFile(fileId) {
      uploadedFiles = uploadedFiles.filter(f => f.id !== fileId);
      updateFileList();
    }
    
    function updateFileList() {
      const fileList = document.getElementById('fileList');
      fileList.innerHTML = '';
      
      uploadedFiles.forEach(file => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        const isExisting = file.isExisting || false;
        fileItem.innerHTML = `
          <div>
            <div class="file-name">${file.name} ${isExisting ? '(existing)' : ''}</div>
            <div class="file-size">${formatFileSize(file.size)}</div>
          </div>
          ${!isExisting ? `<span class="remove-btn" onclick="removeFile(${file.id})">×</span>` : '<span style="color:#10b981;font-size:12px;">✓</span>'}
        `;
        fileList.appendChild(fileItem);
      });
    }
    
    function selectColor(color) {
      document.querySelectorAll('.color-option').forEach(el => el.classList.remove('selected'));
      event.target.classList.add('selected');
      updateCompanyData();
    }
    function onColorPicked(val){
      const hex = String(val || '').trim().toLowerCase();
      const hexInput = document.getElementById('hexInput');
      if(hexInput) hexInput.value = hex;
      // Use a single reusable custom swatch
      const palette = document.querySelector('.color-palette');
      let custom = document.getElementById('custom-color');
      if(!custom){
        custom = document.createElement('div');
        custom.id = 'custom-color';
        custom.className = 'color-option';
        custom.setAttribute('onclick','selectColor()');
        if (palette) palette.prepend(custom);
      }
      custom.style.background = hex;
      custom.dataset.color = hex;
      // Mark as selected
      document.querySelectorAll('.color-option').forEach(el => el.classList.remove('selected'));
      custom.classList.add('selected');
      updateCompanyData();
    }
    function onHexTyped(val){
      const v = String(val||'').trim();
      if(/^#([0-9a-fA-F]{3}){1,2}$/.test(v)){
        const picker = document.getElementById('colorPicker');
        if(picker) picker.value = v;
        onColorPicked(v);
      }
    }
    
    function selectIndustry(industry) {
      const element = event.target;
      if (element.classList.contains('selected')) {
        element.classList.remove('selected');
        companyData.industry = '';
      } else {
        document.querySelectorAll('.industry-tag').forEach(el => el.classList.remove('selected'));
        element.classList.add('selected');
        companyData.industry = industry;
      }
      updateCompanyData();
    }
    
    function selectPersonality(element) {
      document.querySelectorAll('.personality-option').forEach(el => el.classList.remove('selected'));
      element.classList.add('selected');
      updateCompanyData();
    }
    
    function selectResponseLength(element) {
      document.querySelectorAll('.response-option').forEach(el => el.classList.remove('selected'));
      element.classList.add('selected');
      updateCompanyData();
    }
    
    function updateCompanyData() {
      companyData = {
        companyName: document.getElementById('companyName').value,
        companyUrl: document.getElementById('companyUrl').value,
        welcomeMessage: document.getElementById('welcomeMessage') ? document.getElementById('welcomeMessage').value : '',
        primaryColor: document.querySelector('.color-option.selected')?.dataset.color || '#4f46e5',
        tone: document.querySelector('.personality-option.selected')?.dataset.tone || 'Professional',
        industry: document.querySelector('.industry-tag.selected')?.textContent || '',
        responseLength: parseInt(document.querySelector('.response-option.selected')?.dataset.words) || 20,
        avatarUrl: window.__botAvatarUrl || '',
        files: uploadedFiles.map(f => ({
          name: f.name,
          size: f.size,
          type: f.type
        }))
      };
      updatePreview();
      updateUITheme();
    }

    // Avatar helpers
    function onAvatarChosen(e){
      const file = e.target.files && e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = function(){
        window.__botAvatarUrl = reader.result;
        highlightSelectedAvatar(reader.result);
        updatePreview();
      };
      reader.readAsDataURL(file);
    }
    function choosePresetAvatar(url){
      window.__botAvatarUrl = url;
      highlightSelectedAvatar(url);
      updateCompanyData();
    }
    function highlightSelectedAvatar(url){
      document.querySelectorAll('.avatar-item').forEach(el=>el.classList.remove('selected'));
      const match = Array.from(document.querySelectorAll('.avatar-item img')).find(img => img.src === url);
      if(match){ match.parentElement.classList.add('selected'); }
    }
    
    function updateUITheme() {
      const primaryColor = companyData.primaryColor || '#4f46e5';
      
      // Update CSS custom properties
      document.documentElement.style.setProperty('--primary-color', primaryColor);
      
      // Update button colors
      const primaryButtons = document.querySelectorAll('.btn-primary');
      primaryButtons.forEach(btn => {
        btn.style.backgroundColor = primaryColor;
        btn.style.borderColor = primaryColor;
      });
      
      // Update focus states
      const inputs = document.querySelectorAll('input, select, textarea');
      inputs.forEach(input => {
        input.style.setProperty('--focus-color', primaryColor);
      });
      
      // Update file upload border
      const dropZone = document.getElementById('dropZone');
      if (dropZone) {
        dropZone.style.setProperty('--drag-color', primaryColor);
      }
      
      // Update progress bar
      const progressBars = document.querySelectorAll('.progress-fill');
      progressBars.forEach(bar => {
        bar.style.backgroundColor = primaryColor;
      });
    }
    
    function updatePreview() {
      const preview = document.getElementById('preview');
      if (!companyData.companyName) {
        preview.innerHTML = '<p style="color:#6b7280;text-align:center;">Fill in company details to see preview</p>';
        return;
      }
      
      preview.innerHTML = `
        <div style="max-width:520px;border-radius:14px;background:#0b0f1a;border:1px solid #1f2937; overflow:hidden; box-shadow:0 20px 40px rgba(0,0,0,.45);">
          <div style="background:#111827;color:#e5e7eb;padding:10px 12px;display:flex;align-items:center;gap:10px;">
            ${companyData.avatarUrl ? `<img src="${companyData.avatarUrl}" style="width:26px;height:26px;border-radius:6px;border:1px solid #374151;object-fit:cover;"/>` : `<div style=\"width:26px;height:26px;border-radius:6px;background:${companyData.primaryColor};\"></div>`}
            <div style="font-weight:600;font-size:14px;">${companyData.companyName}</div>
            <div style="margin-left:auto;display:flex;gap:6px;">
              <span style="width:8px;height:8px;border-radius:50%;background:#9ca3af;"></span>
              <span style="width:8px;height:8px;border-radius:50%;background:#9ca3af;"></span>
              <span style="width:8px;height:8px;border-radius:50%;background:#9ca3af;"></span>
            </div>
          </div>
          <div style="background:linear-gradient(135deg,#0a0a0a,#111827);padding:14px;">
            <div style="display:flex;flex-direction:column;gap:10px;">
              <div style="align-self:flex-start;max-width:72%;background:rgba(55,65,81,.25);color:#e5e7eb;border:1px solid rgba(255,255,255,.12);padding:10px 12px;border-radius:14px;">${companyData.welcomeMessage || 'Hello there! How can I help you today?'}</div>
              <div style="align-self:flex-end;max-width:72%;background:#374151;color:#fff;padding:10px 12px;border-radius:14px;">User’s Reply</div>
              <div style="align-self:flex-start;max-width:72%;background:rgba(55,65,81,.25);color:#e5e7eb;border:1px solid rgba(255,255,255,.12);padding:10px 12px;border-radius:14px;">Here is an example response from your chatbot based on your settings.</div>
              <div style="align-self:flex-end;max-width:72%;background:#374151;color:#fff;padding:10px 12px;border-radius:14px;">Sounds good!</div>
          </div>
            <div style="margin-top:12px;border-top:1px dashed #374151;padding-top:10px;color:#9ca3af;font-size:12px;">${companyData.companyUrl || 'https://yourcompany.com'}</div>
          </div>
        </div>`;
    }
    
    async function saveConfiguration() {
      if(!ensureAuth()) return;
      
      const username = localStorage.getItem('username') || '';
      const token = localStorage.getItem('token') || '';
      
      if(!username || !token) {
        showMessage('Missing authentication data', 'err');
        return;
      }
      
      if(uploadedFiles.length === 0) {
        showMessage('Please upload at least one file', 'err');
        return;
      }
      
      if(!companyData.companyName) {
        showMessage('Please enter company name', 'err');
        return;
      }
      
      try {
        showMessage('Saving configuration...', 'ok');
        
        // Save company data
        const companyResponse = await fetch('/save_company_config', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({
            username: username,
            ...companyData
          })
        });
        
        if (!companyResponse.ok) {
          throw new Error('Failed to save company configuration');
        }
        
        // Upload files
        for (const fileData of uploadedFiles) {
          const formData = new FormData();
          formData.append('file', fileData.file);
          formData.append('username', username);
          formData.append('fileType', fileData.type);
          
          const fileResponse = await fetch('/upload_knowledge_base?username=' + encodeURIComponent(username), {
            method: 'POST',
            body: formData,
            headers: {
              'Authorization': 'Bearer ' + token
            }
          });
          
          if (!fileResponse.ok) {
            throw new Error(`Failed to upload ${fileData.name}`);
          }
        }
        
        showMessage('Configuration saved successfully!', 'ok');
        
        // Redirect to next step or back to dashboard
        setTimeout(() => {
          // After saving, take user to script tag page using token
          location.href = '/scripttag?token=' + encodeURIComponent(token);
        }, 1200);
        
      } catch (error) {
        showMessage('Error: ' + error.message, 'err');
      }
    }
    
    function showMessage(message, type) {
      const resEl = document.getElementById('res');
      resEl.textContent = message;
      resEl.className = type;
    }
    
    function next(){ 
      if(ensureAuth()) {
        const t = localStorage.getItem('token') || '';
        location.href='/scripttag?token=' + encodeURIComponent(t);
      }
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      try { renderStepper(); } catch(_) {}
      // Set animated SVG thumbnails for avatar grid
      // Initialize Lottie avatars (robust)
      function initLottieAvatars(){
        if (!window.lottie) return;
        const nodes = document.querySelectorAll('.avatar-item.lottie');
        nodes.forEach((node) => {
          // Clear previous content if any
          node.innerHTML = '';
          const url = node.getAttribute('data-lottie');
          try {
            const anim = lottie.loadAnimation({ container: node, renderer: 'svg', loop: true, autoplay: true, path: url });
            node.addEventListener('click', () => {
              nodes.forEach(n => n.classList.remove('selected'));
              node.classList.add('selected');
              try {
                const svg = node.querySelector('svg');
                if (svg) {
                  const serializer = new XMLSerializer();
                  const data = 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(serializer.serializeToString(svg));
                  window.__botAvatarUrl = data;
                  updateCompanyData();
                }
              } catch(_) {}
            });
          } catch(_) {}
        });
      }
      // No lottie needed for static robot presets; keep functions defined for safety

      // Load existing data if available
      loadExistingData();
      
      // Add event listeners
      document.getElementById('fileInput').addEventListener('change', handleFileSelect);
      document.getElementById('dropZone').addEventListener('drop', handleDrop);
      document.getElementById('dropZone').addEventListener('dragover', handleDragOver);
      document.getElementById('dropZone').addEventListener('dragleave', handleDragLeave);
      document.getElementById('dropZone').addEventListener('click', function(e) {
        // Only trigger if clicking on the drop zone itself, not on the button
        if (e.target === document.getElementById('dropZone') || e.target.tagName === 'P') {
          document.getElementById('fileInput').click();
        }
      });
      
      // Add input listeners for real-time preview
      ['companyName', 'companyUrl', 'welcomeMessage'].forEach(id => {
        document.getElementById(id).addEventListener('input', updateCompanyData);
      });
      
      // Set default personality selection if none selected
      if (!document.querySelector('.personality-option.selected')) {
      const firstPersonality = document.querySelector('.personality-option');
      if (firstPersonality) {
        firstPersonality.classList.add('selected');
        }
      }
      
      // Populate flat avatar presets (7)
      try {
        const ids = ['avatar1','avatar2','avatar3','avatar4','avatar5','avatar6','avatar7'];
        ids.forEach((id, idx) => { const img = document.getElementById(id); if (img && window.__avatars[idx]) { img.src = window.__avatars[idx]; }});
      } catch(_) {}
 
      // Set default avatar if none selected
      if (!window.__botAvatarUrl) {
        const defaultAvatar = (window.__avatars && window.__avatars[0]) ? window.__avatars[0] : '';
        if (defaultAvatar) {
          window.__botAvatarUrl = defaultAvatar;
          highlightSelectedAvatar(defaultAvatar);
        }
      }
      
      updatePreview();
    });
    
    function loadExistingData() {
      // Load company configuration
      const companyConfig = JSON.parse((document.getElementById('company-config')?.textContent)||'{}');
      if (companyConfig && Object.keys(companyConfig).length > 0) {
        // Fill form fields
        if (companyConfig.companyName) {
          document.getElementById('companyName').value = companyConfig.companyName;
        }
        if (companyConfig.companyUrl) {
          document.getElementById('companyUrl').value = companyConfig.companyUrl;
        }
        // companyDescription removed from setup UI
        if (companyConfig.welcomeMessage) {
          document.getElementById('welcomeMessage').value = companyConfig.welcomeMessage;
        }
        
        // Set primary color
        if (companyConfig.primaryColor) {
          const colorOption = document.querySelector(`[data-color="${companyConfig.primaryColor}"]`);
          if (colorOption) {
            document.querySelectorAll('.color-option').forEach(el => el.classList.remove('selected'));
            colorOption.classList.add('selected');
          }
        }
        
        // Set personality
        if (companyConfig.tone) {
          const personalityOption = document.querySelector(`[data-tone="${companyConfig.tone}"]`);
          if (personalityOption) {
            document.querySelectorAll('.personality-option').forEach(el => el.classList.remove('selected'));
            personalityOption.classList.add('selected');
          }
        }
        
        // Set industry
        if (companyConfig.industry) {
          const industryTag = Array.from(document.querySelectorAll('.industry-tag')).find(tag => tag.textContent === companyConfig.industry);
          if (industryTag) {
            document.querySelectorAll('.industry-tag').forEach(el => el.classList.remove('selected'));
            industryTag.classList.add('selected');
          }
        }
        
        // Set response length
        if (companyConfig.responseLength) {
          const responseOption = document.querySelector(`[data-words="${companyConfig.responseLength}"]`);
          if (responseOption) {
            document.querySelectorAll('.response-option').forEach(el => el.classList.remove('selected'));
            responseOption.classList.add('selected');
          }
        }
        
        // Set avatar
        if (companyConfig.avatarUrl) {
          window.__botAvatarUrl = companyConfig.avatarUrl;
          highlightSelectedAvatar(companyConfig.avatarUrl);
        }
      }
      
      // Load knowledge base files info
      const knowledgeBase = JSON.parse((document.getElementById('knowledge-base')?.textContent)||'[]');
      if (knowledgeBase && knowledgeBase.length > 0) {
        // Add existing files to the file list (for display purposes)
        knowledgeBase.forEach((file, index) => {
          const fileItem = {
            id: Date.now() + index,
            name: file.name || `File ${index + 1}`,
            size: file.size || 0,
            type: file.type || 'text/plain',
            isExisting: true
          };
          uploadedFiles.push(fileItem);
        });
        updateFileList();
      }
    }
  </script>
</head>
<body onload="ensureAuth()">
  <script type="application/json" id="company-config">{{ company_config | tojson }}</script>
  <script type="application/json" id="knowledge-base">{{ knowledge_base | tojson }}</script>
  <div class="container">
  <div class="card">
      <h1>{% if bot %}Edit Your Chatbot{% else %}Setup Your Chatbot{% endif %}</h1>
      <p class="sub">{% if bot %}Modify your chatbot's configuration, knowledge base, and customization options.{% else %}Configure your chatbot with company information, knowledge base, and customization options.{% endif %}</p>
      
      <!-- Wizard header -->
      <div class="stepper" aria-label="Setup steps">
        <span class="step-dot" data-step-index="1"></span>
        <span class="step-dot" data-step-index="2"></span>
        <span class="step-dot" data-step-index="3"></span>
      </div>

      <!-- Company Information Section (Step 1) -->
      <div class="section-divider"></div>
      <div data-step="1">
      <h2>🏢 Company Information</h2>
      <div class="form-grid">
        <div class="form-group">
          <label for="companyName">Company Name *</label>
          <input type="text" id="companyName" placeholder="Enter your company name" required>
        </div>
        <div class="form-group">
          <label for="companyUrl">Company Website</label>
          <input type="url" id="companyUrl" placeholder="https://yourcompany.com">
        </div>
      </div>
      
      
      
      <!-- Industry Selection -->
      <div class="form-group">
        <label>🏭 Industry</label>
        <div class="industry-tags">
          <span class="industry-tag" onclick="selectIndustry('Technology')">Technology</span>
          <span class="industry-tag" onclick="selectIndustry('Healthcare')">Healthcare</span>
          <span class="industry-tag" onclick="selectIndustry('Finance')">Finance</span>
          <span class="industry-tag" onclick="selectIndustry('Education')">Education</span>
          <span class="industry-tag" onclick="selectIndustry('E-commerce')">E-commerce</span>
          <span class="industry-tag" onclick="selectIndustry('Real Estate')">Real Estate</span>
          <span class="industry-tag" onclick="selectIndustry('Manufacturing')">Manufacturing</span>
          <span class="industry-tag" onclick="selectIndustry('Consulting')">Consulting</span>
          <span class="industry-tag" onclick="selectIndustry('Retail')">Retail</span>
          <span class="industry-tag" onclick="selectIndustry('Other')">Other</span>
        </div>
        </div>
      </div>
      
      <!-- Chatbot Customization Section (Step 2) -->
      <div class="section-divider"></div>
      <div data-step="2" style="display:none;">
      <h2>🤖 Chatbot Customization</h2>
      
        <div class="form-group">
        <label for="welcomeMessage">💬 Welcome Message</label>
          <textarea id="welcomeMessage" placeholder="e.g., Welcome to Acme! Ask me anything about our services."></textarea>
        <small style="color: #9ca3af; font-size: 12px; margin-top: 4px; display: block;">This message will be shown when users start a conversation with your chatbot.</small>
        </div>
      
        <div class="form-group">
        <label>🎭 Personality & Tone</label>
          <div class="personality-options">
            <div class="personality-option" data-tone="Professional" onclick="selectPersonality(this)">
              <div class="personality-header">
                <span class="personality-emoji">💼</span>
                <span class="personality-name">Professional</span>
              </div>
              <p class="personality-desc">Clear, concise, and business-focused responses. Perfect for corporate environments.</p>
            </div>
            
            <div class="personality-option" data-tone="Friendly" onclick="selectPersonality(this)">
              <div class="personality-header">
                <span class="personality-emoji">😊</span>
                <span class="personality-name">Friendly</span>
              </div>
              <p class="personality-desc">Warm, approachable, and conversational. Great for customer service and retail.</p>
            </div>
            
            <div class="personality-option" data-tone="Humorous" onclick="selectPersonality(this)">
              <div class="personality-header">
                <span class="personality-emoji">😄</span>
                <span class="personality-name">Humorous</span>
              </div>
            <p class="personality-desc">Light-hearted with tasteful humor and emojis. Keeps conversations engaging without losing clarity.</p>
            </div>
            
            <div class="personality-option" data-tone="Expert" onclick="selectPersonality(this)">
              <div class="personality-header">
                <span class="personality-emoji">🎓</span>
                <span class="personality-name">Expert</span>
              </div>
              <p class="personality-desc">Knowledgeable, detailed, and authoritative. Ideal for technical and educational services.</p>
            </div>
            
            <div class="personality-option" data-tone="Caring" onclick="selectPersonality(this)">
              <div class="personality-header">
                <span class="personality-emoji">🤗</span>
                <span class="personality-name">Caring</span>
              </div>
              <p class="personality-desc">Empathetic, supportive, and understanding. Perfect for healthcare, wellness, and personal services.</p>
            </div>
            
            <div class="personality-option" data-tone="Enthusiastic" onclick="selectPersonality(this)">
              <div class="personality-header">
                <span class="personality-emoji">🚀</span>
                <span class="personality-name">Enthusiastic</span>
              </div>
              <p class="personality-desc">Energetic, positive, and motivating. Great for fitness, entertainment, and startup companies.</p>
            </div>
            
            <div class="personality-option" data-tone="Casual" onclick="selectPersonality(this)">
              <div class="personality-header">
                <span class="personality-emoji">👋</span>
                <span class="personality-name">Casual</span>
              </div>
              <p class="personality-desc">Relaxed, informal, and conversational. Perfect for lifestyle brands and social platforms.</p>
            </div>
          </div>
        </div>
      
      <div class="form-grid">
        <div class="form-group">
          <label>🎨 Primary Color</label>
          <div class="color-row">
            <div class="color-advanced">
              <input id="colorPicker" type="color" value="#7c3aed" oninput="onColorPicked(this.value)">
              <input id="hexInput" class="hex-input" placeholder="#A855F7" value="#7c3aed" oninput="onHexTyped(this.value)">
            </div>
          <div class="color-palette">
            <div class="color-option selected" data-color="#4f46e5" style="background:#4f46e5" onclick="selectColor()"></div>
            <div class="color-option" data-color="#7c3aed" style="background:#7c3aed" onclick="selectColor()"></div>
              <div class="color-option" data-color="#a855f7" style="background:#a855f7" onclick="selectColor()"></div>
              <div class="color-option" data-color="#6b21a8" style="background:#6b21a8" onclick="selectColor()"></div>
              <div class="color-option" data-color="#3b82f6" style="background:#3b82f6" onclick="selectColor()"></div>
              <div class="color-option" data-color="#22c55e" style="background:#22c55e" onclick="selectColor()"></div>
              <div class="color-option" data-color="#f59e0b" style="background:#f59e0b" onclick="selectColor()"></div>
              <div class="color-option" data-color="#ef4444" style="background:#ef4444" onclick="selectColor()"></div>
          </div>
        </div>
        </div>
        
        <div class="form-group">
          <label>📏 Response Length</label>
          <div class="response-length-options">
            <div class="response-option selected" data-words="20" onclick="selectResponseLength(this)">
              <div class="response-header">
                <span class="response-emoji">⚡</span>
                <span class="response-name">Very Short (15-20 words)</span>
              </div>
              <p class="response-desc">Ultra-brief responses. Perfect for quick confirmations and mobile users.</p>
            </div>
            
            <div class="response-option" data-words="35" onclick="selectResponseLength(this)">
              <div class="response-header">
                <span class="response-emoji">📝</span>
                <span class="response-name">Short (30-35 words)</span>
              </div>
              <p class="response-desc">Brief, concise responses. Great for quick answers and social media.</p>
            </div>
              </div>
            </div>
              </div>
            </div>
            
      <!-- Knowledge Base Section -->
      <div class="section-divider"></div>
      <div data-step="3" style="display:none;">
      <h2>🤳 Bot Avatar</h2>
      <p style="color:#ffffff;margin-bottom:12px;font-size:14px;">Choose one of our presets.</p>
      <div class="form-grid">
        <div class="form-group">
          <label>Choose a preset</label>
          <div class="avatar-grid" id="avatarGrid">
            <div class="avatar-item" title="Cowboy (Male)" onclick="choosePresetAvatar(window.__avatars[0])"><img src="" id="avatar1" alt="Cowboy Male"></div>
            <div class="avatar-item" title="Doctor (Female)" onclick="choosePresetAvatar(window.__avatars[1])"><img src="" id="avatar2" alt="Doctor Female"></div>
            <div class="avatar-item" title="Humorous (Male)" onclick="choosePresetAvatar(window.__avatars[2])"><img src="" id="avatar3" alt="Humorous Male"></div>
            <div class="avatar-item" title="Expert (Male)" onclick="choosePresetAvatar(window.__avatars[3])"><img src="" id="avatar4" alt="Expert Male"></div>
            <div class="avatar-item" title="Caring (Female)" onclick="choosePresetAvatar(window.__avatars[4])"><img src="" id="avatar5" alt="Caring Female"></div>
            <div class="avatar-item" title="Enthusiastic (Male)" onclick="choosePresetAvatar(window.__avatars[5])"><img src="" id="avatar6" alt="Custom Smiling"></div>
            <div class="avatar-item" title="Casual (Female)" onclick="choosePresetAvatar(window.__avatars[6])"><img src="" id="avatar7" alt="Casual Female"></div>
          </div>
        </div>
      </div>
      
      <!-- Knowledge Base Section -->
      <div class="section-divider"></div>
      <h2>📚 Knowledge Base Files</h2>
      <p style="color: #ffffff; margin-bottom: 20px; font-size: 14px;">Upload files to train your chatbot with your company's information, FAQs, and knowledge.</p>
      
      <div class="file-upload" id="dropZone">
        <div style="text-align: center;">
          <p style="margin:0 0 8px;color:#ffffff;font-size:16px;">📁 Click here or drag and drop files</p>
          <p style="margin:0 0 16px;font-size:13px;color:#9ca3af;">Supported formats: JSON, TXT, PDF, Word, Excel, CSV</p>
          <button type="button" class="btn btn-primary" onclick="document.getElementById('fileInput').click()" style="margin-bottom: 8px;">
            📁 Choose Files
          </button>
          <p style="margin:0;font-size:12px;color:#9ca3af;">or drag files directly onto this area</p>
        </div>
        <input type="file" id="fileInput" multiple style="display:none;" accept=".json,.txt,.pdf,.doc,.docx,.xls,.xlsx,.csv">
      </div>
      
      <div class="file-list" id="fileList"></div>
      
      <!-- Preview Section -->
      <div class="section-divider"></div>
      <h2>👁️ Preview</h2>
      <p style="color: #ffffff; margin-bottom: 20px; font-size: 14px;">See how your chatbot will appear to users based on your current settings.</p>
      <div class="preview-section">
        <div id="preview" style="padding:0"></div>
      </div>
    </div>
      
      <!-- Status and Actions -->
    <div id="res" class="sub"></div>
      <div class="wizard-actions">
        <button id="step-prev" class="btn ghost" onclick="gotoStep(-1)">◀ Previous</button>
        <div>
          <button id="step-next" class="btn btn-primary" onclick="gotoStep(1)">Next ▶</button>
          <button id="step-finish" class="btn btn-primary" style="display:none;" onclick="saveConfiguration()">Finish ✓</button>
        </div>
      </div>
    </div>
  </div>
</body>
</html>



