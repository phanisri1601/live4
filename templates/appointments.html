<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Appointments</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#0f172a;margin:0;color:#e5e7eb;overflow-x:hidden;width:100vw;max-width:100vw}
    .top{background:#111827;color:#fff;padding:16px 20px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #1f2937;flex-wrap:wrap;gap:8px}
    .wrap{padding:20px;width:100%;box-sizing:border-box}
    .panel{background:#0b1220;border:1px solid #1f2937;border-radius:12px;overflow:hidden;width:100%;box-sizing:border-box}
    .panel h3{margin:0;padding:14px 16px;border-bottom:1px solid #1f2937;word-wrap:break-word;overflow-wrap:break-word}
    .panel .body{padding:16px;width:100%;box-sizing:border-box}
    .btn{padding:8px 10px;border:1px solid #334155;border-radius:8px;background:#111827;color:#e5e7eb;cursor:pointer;box-sizing:border-box;word-wrap:break-word;overflow-wrap:break-word}
    .btn-danger{background:#b91c1c;border-color:#7f1d1d}
    .menu{position:relative;display:inline-block;z-index:10000}
    .menu-btn{width:34px;height:34px;border:1px solid #334155;border-radius:8px;background:#111827;color:#e5e7eb;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .menu-btn:hover{background:#1f2937}
    .menu-list{position:absolute;top:38px;right:0;min-width:140px;background:#0b1220;border:1px solid #1f2937;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.35);padding:6px;display:none;z-index:10001}
    .menu.open .menu-list{display:block}
    .menu-item{display:flex;gap:8px;align-items:center;padding:8px 10px;border-radius:8px;color:#e5e7eb;cursor:pointer}
    .menu-item:hover{background:#111827}
    .menu-flyout{position:fixed;min-width:160px;background:#0b1220;border:1px solid #1f2937;border-radius:10px;box-shadow:0 12px 28px rgba(0,0,0,.45);padding:6px;z-index:100000}
    .menu-flyout .menu-item{padding:8px 10px;border-radius:8px;color:#e5e7eb;cursor:pointer;white-space:nowrap}
    .menu-flyout .menu-item:hover{background:#111827}
    .search-container{display:flex;gap:8px;margin-bottom:16px;align-items:center}
    .search-input{flex:1;padding:8px 12px;border:1px solid #334155;border-radius:8px;background:#111827;color:#e5e7eb;font-size:14px;box-sizing:border-box}
    .search-input:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 2px rgba(59,130,246,0.2)}
    .search-input::placeholder{color:#6b7280}
    .tablewrap{max-height:80vh;overflow-x:auto;overflow-y:auto;width:100%;box-sizing:border-box;-webkit-overflow-scrolling:touch;border:1px solid #1f2937;border-radius:8px;position:relative}
    .tablewrap::-webkit-scrollbar{height:8px;width:8px}
    .tablewrap::-webkit-scrollbar-track{background:#1f2937;border-radius:4px}
    .tablewrap::-webkit-scrollbar-thumb{background:#4b5563;border-radius:4px}
    .tablewrap::-webkit-scrollbar-thumb:hover{background:#6b7280}
    table{width:100%;border-collapse:collapse;font-size:14px;min-width:1800px;table-layout:fixed}
    th,td{padding:10px;border-bottom:1px solid #1f2937;color:#cbd5e1;word-wrap:break-word;overflow-wrap:break-word;box-sizing:border-box;vertical-align:top;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    th{position:sticky;top:0;background:#111827;color:#93c5fd;text-transform:uppercase;font-size:12px;letter-spacing:.05em;z-index:10}
    .small{color:#94a3b8;font-size:12px;word-wrap:break-word;overflow-wrap:break-word}
    .pill{background:#064e3b;color:#34d399;padding:4px 8px;border-radius:9999px;font-size:12px}
    
    /* Scroll indicator */
    .tablewrap::after{content:"← Scroll horizontally to see all columns →";position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.8);color:#fff;padding:8px 16px;border-radius:20px;font-size:12px;pointer-events:none;opacity:0;transition:opacity 0.3s ease;z-index:20}
    .tablewrap:hover::after{opacity:1}
    
    /* Fixed column widths for consistent display */
    th:nth-child(1), td:nth-child(1) { width: 350px; min-width: 350px; } /* Title */
    th:nth-child(2), td:nth-child(2) { width: 350px; min-width: 350px; } /* Time */
    th:nth-child(3), td:nth-child(3) { width: 350px; min-width: 350px; } /* Notes */
    th:nth-child(4), td:nth-child(4) { width: 250px; min-width: 250px; } /* Appointment ID */
    th:nth-child(5), td:nth-child(5) { width: 350px; min-width: 350px; } /* User */
    th:nth-child(6), td:nth-child(6) { width: 200px; min-width: 200px; } /* Status */
    th:nth-child(7), td:nth-child(7) { width: 200px; min-width: 200px; } /* Actions */
    
    /* iPad Mini and similar tablets (768x1024) */
    @media (max-width: 1024px) and (min-width: 768px) {
      .top{padding:12px 16px;flex-wrap:wrap;gap:6px}
      .wrap{padding:16px}
      .panel h3{padding:12px 14px;font-size:16px}
      .panel .body{padding:14px}
      .search-container{margin-bottom:12px}
      .search-input{font-size:13px;padding:6px 10px}
      .tablewrap{overflow-x:auto;overflow-y:auto;-webkit-overflow-scrolling:touch;width:100%;position:relative}
      .tablewrap::-webkit-scrollbar{height:12px;width:12px}
      .tablewrap::-webkit-scrollbar-track{background:#1f2937;border-radius:6px}
      .tablewrap::-webkit-scrollbar-thumb{background:#6b7280;border-radius:6px;border:2px solid #1f2937}
      .tablewrap::-webkit-scrollbar-thumb:hover{background:#9ca3af}
      table{font-size:13px;min-width:2000px;table-layout:fixed;width:2000px}
      th,td{padding:8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
      th{font-size:11px}
      .small{font-size:11px}
      
      /* Fixed column widths for iPad Mini - wider to ensure scrolling */
      th:nth-child(1), td:nth-child(1) { width: 450px; min-width: 450px; } /* Title */
      th:nth-child(2), td:nth-child(2) { width: 350px; min-width: 350px; } /* Time */
      th:nth-child(3), td:nth-child(3) { width: 450px; min-width: 450px; } /* Notes */
      th:nth-child(4), td:nth-child(4) { width: 300px; min-width: 300px; } /* Appointment ID */
      th:nth-child(5), td:nth-child(5) { width: 350px; min-width: 350px; } /* User */
      th:nth-child(6), td:nth-child(6) { width: 250px; min-width: 250px; } /* Status */
      th:nth-child(7), td:nth-child(7) { width: 250px; min-width: 250px; } /* Actions */
      
      /* Enhanced scroll indicator for iPad Mini */
      .tablewrap::after{content:"← Swipe left to see more columns →";position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.9);color:#fff;padding:12px 20px;border-radius:25px;font-size:14px;pointer-events:none;opacity:0;transition:opacity 0.3s ease;z-index:20;font-weight:bold}
      .tablewrap:hover::after{opacity:1}
    }
    
    /* iPad Air and similar tablets (820x1180) */
    @media (max-width: 1024px) and (min-width: 820px) {
      .top{padding:12px 16px;flex-wrap:wrap;gap:6px}
      .wrap{padding:16px}
      .panel h3{padding:12px 14px;font-size:16px}
      .panel .body{padding:14px}
      .tablewrap{overflow-x:auto;overflow-y:auto;-webkit-overflow-scrolling:touch;width:100%;max-width:100%}
      table{font-size:13px;min-width:1800px;table-layout:fixed;width:1800px}
      th,td{padding:8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
      th{font-size:11px}
      .small{font-size:11px}
      
      /* Fixed column widths for iPad Air - wider to ensure scrolling */
      th:nth-child(1), td:nth-child(1) { width: 400px; min-width: 400px; } /* Title */
      th:nth-child(2), td:nth-child(2) { width: 300px; min-width: 300px; } /* Time */
      th:nth-child(3), td:nth-child(3) { width: 400px; min-width: 400px; } /* Notes */
      th:nth-child(4), td:nth-child(4) { width: 200px; min-width: 200px; } /* Appointment ID */
      th:nth-child(5), td:nth-child(5) { width: 300px; min-width: 300px; } /* User */
      th:nth-child(6), td:nth-child(6) { width: 150px; min-width: 150px; } /* Status */
      th:nth-child(7), td:nth-child(7) { width: 150px; min-width: 150px; } /* Actions */
    }
    
    /* Other tablets and smaller desktop */
    @media (max-width: 1024px) {
      .top{padding:12px 16px;flex-wrap:wrap;gap:6px}
      .wrap{padding:16px}
      .panel h3{padding:12px 14px;font-size:16px}
      .panel .body{padding:14px}
      .tablewrap{overflow-x:auto;overflow-y:auto;-webkit-overflow-scrolling:touch;width:100%;max-width:100%}
      table{font-size:13px;min-width:1800px;table-layout:fixed;width:1400px}
      th,td{padding:8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
      th{font-size:11px}
      .small{font-size:11px}
      
      /* Fixed column widths for tablet */
      th:nth-child(1), td:nth-child(1) { width: 300px; min-width: 300px; } /* Title */
      th:nth-child(2), td:nth-child(2) { width: 200px; min-width: 200px; } /* Time */
      th:nth-child(3), td:nth-child(3) { width: 300px; min-width: 300px; } /* Notes */
      th:nth-child(4), td:nth-child(4) { width: 150px; min-width: 150px; } /* Appointment ID */
      th:nth-child(5), td:nth-child(5) { width: 200px; min-width: 200px; } /* User */
      th:nth-child(6), td:nth-child(6) { width: 120px; min-width: 120px; } /* Status */
      th:nth-child(7), td:nth-child(7) { width: 120px; min-width: 120px; } /* Actions */
    }
    
    /* Mobile landscape and small tablets */
    @media (max-width: 768px) {
      .top{padding:10px 12px;flex-direction:column;align-items:flex-start;gap:8px}
      .top div:first-child{font-size:16px}
      .top .small{font-size:12px}
      .wrap{padding:12px}
      .panel h3{padding:10px 12px;font-size:15px}
      .panel .body{padding:12px}
      .search-container{margin-bottom:10px}
      .search-input{font-size:12px;padding:6px 8px}
      .btn{padding:6px 8px;font-size:13px}
      table{font-size:12px;min-width:1800px;table-layout:fixed}
      th,td{padding:6px;font-size:12px}
      th{font-size:10px;padding:6px 4px}
      .small{font-size:10px}
      
      /* Fixed column widths for mobile landscape */
      th:nth-child(1), td:nth-child(1) { width: 300px; min-width: 300px; } /* Title */
      th:nth-child(2), td:nth-child(2) { width: 200px; min-width: 200px; } /* Time */
      th:nth-child(3), td:nth-child(3) { width: 300px; min-width: 300px; } /* Notes */
      th:nth-child(4), td:nth-child(4) { width: 150px; min-width: 150px; } /* Appointment ID */
      th:nth-child(5), td:nth-child(5) { width: 200px; min-width: 200px; } /* User */
      th:nth-child(6), td:nth-child(6) { width: 120px; min-width: 120px; } /* Status */
      th:nth-child(7), td:nth-child(7) { width: 120px; min-width: 120px; } /* Actions */
    }
    
    /* Mobile portrait */
    @media (max-width: 480px) {
      .top{padding:8px 10px;flex-direction:column;align-items:flex-start;gap:6px}
      .top div:first-child{font-size:14px}
      .top .small{font-size:11px}
      .wrap{padding:10px}
      .panel h3{padding:8px 10px;font-size:14px}
      .panel .body{padding:10px}
      .btn{padding:5px 7px;font-size:12px}
      table{font-size:11px;min-width:1800px;table-layout:fixed}
      th,td{padding:4px;font-size:11px}
      th{font-size:9px;padding:4px 3px}
      .small{font-size:9px}
      
      /* Fixed column widths for mobile portrait */
      th:nth-child(1), td:nth-child(1) { width: 300px; min-width: 300px; } /* Title */
      th:nth-child(2), td:nth-child(2) { width: 200px; min-width: 200px; } /* Time */
      th:nth-child(3), td:nth-child(3) { width: 300px; min-width: 300px; } /* Notes */
      th:nth-child(4), td:nth-child(4) { width: 150px; min-width: 150px; } /* Appointment ID */
      th:nth-child(5), td:nth-child(5) { width: 200px; min-width: 200px; } /* User */
      th:nth-child(6), td:nth-child(6) { width: 120px; min-width: 120px; } /* Status */
      th:nth-child(7), td:nth-child(7) { width: 120px; min-width: 120px; } /* Actions */
    }
    
    /* Very small mobile */
    @media (max-width: 360px) {
      .top{padding:6px 8px;flex-direction:column;align-items:flex-start;gap:4px}
      .top div:first-child{font-size:13px}
      .top .small{font-size:10px}
      .wrap{padding:8px}
      .panel h3{padding:6px 8px;font-size:13px}
      .panel .body{padding:8px}
      .btn{padding:4px 6px;font-size:11px}
      table{font-size:10px;min-width:1800px;table-layout:fixed}
      th,td{padding:3px;font-size:10px}
      th{font-size:8px;padding:3px 2px}
      .small{font-size:8px}
      
      /* Fixed column widths for very small mobile */
      th:nth-child(1), td:nth-child(1) { width: 300px; min-width: 300px; } /* Title */
      th:nth-child(2), td:nth-child(2) { width: 200px; min-width: 200px; } /* Time */
      th:nth-child(3), td:nth-child(3) { width: 300px; min-width: 300px; } /* Notes */
      th:nth-child(4), td:nth-child(4) { width: 150px; min-width: 150px; } /* Appointment ID */
      th:nth-child(5), td:nth-child(5) { width: 200px; min-width: 200px; } /* User */
      th:nth-child(6), td:nth-child(6) { width: 120px; min-width: 120px; } /* Status */
      th:nth-child(7), td:nth-child(7) { width: 120px; min-width: 120px; } /* Actions */
    }
    
    /* Ultra small mobile */
    @media (max-width: 320px) {
      .top{padding:4px 6px;flex-direction:column;align-items:flex-start;gap:3px}
      .top div:first-child{font-size:12px}
      .top .small{font-size:9px}
      .wrap{padding:6px}
      .panel h3{padding:4px 6px;font-size:12px}
      .panel .body{padding:6px}
      .btn{padding:3px 5px;font-size:10px}
      table{font-size:9px;min-width:1800px;table-layout:fixed}
      th,td{padding:2px;font-size:9px}
      th{font-size:7px;padding:2px 1px}
      .small{font-size:7px}
      
      /* Fixed column widths for ultra small mobile */
      th:nth-child(1), td:nth-child(1) { width: 300px; min-width: 300px; } /* Title */
      th:nth-child(2), td:nth-child(2) { width: 200px; min-width: 200px; } /* Time */
      th:nth-child(3), td:nth-child(3) { width: 300px; min-width: 300px; } /* Notes */
      th:nth-child(4), td:nth-child(4) { width: 150px; min-width: 150px; } /* Appointment ID */
      th:nth-child(5), td:nth-child(5) { width: 200px; min-width: 200px; } /* User */
      th:nth-child(6), td:nth-child(6) { width: 120px; min-width: 120px; } /* Status */
      th:nth-child(7), td:nth-child(7) { width: 120px; min-width: 120px; } /* Actions */
    }
    
    /* Landscape mobile */
    @media (max-width: 768px) and (orientation: landscape) {
      .top{padding:8px 12px;flex-direction:row;justify-content:space-between;align-items:center}
      .wrap{padding:10px 12px}
      .panel h3{padding:8px 12px;font-size:14px}
      .panel .body{padding:10px}
      table{font-size:11px;min-width:1800px;table-layout:fixed}
      th,td{padding:5px}
      th{font-size:9px}
      .small{font-size:9px}
      
      /* Fixed column widths for landscape mobile */
      th:nth-child(1), td:nth-child(1) { width: 300px; min-width: 300px; } /* Title */
      th:nth-child(2), td:nth-child(2) { width: 200px; min-width: 200px; } /* Time */
      th:nth-child(3), td:nth-child(3) { width: 300px; min-width: 300px; } /* Notes */
      th:nth-child(4), td:nth-child(4) { width: 150px; min-width: 150px; } /* Appointment ID */
      th:nth-child(5), td:nth-child(5) { width: 200px; min-width: 200px; } /* User */
      th:nth-child(6), td:nth-child(6) { width: 120px; min-width: 120px; } /* Status */
      th:nth-child(7), td:nth-child(7) { width: 120px; min-width: 120px; } /* Actions */
    }
  </style>
</head>
<body>
  <div class="top">
    <div><strong>Product Sales Dashboard</strong></div>
    <div class="small">Logged in: {{ username }}</div>
  </div>
  <div class="wrap">
    <div style="margin-bottom:12px;display:flex;gap:8px;align-items:center">
      <button class="btn" onclick="history.back()">← Back</button>
      <button class="btn" onclick="location.reload()">Refresh</button>
    </div>
    <div class="panel">
      <h3>Appointment Schedule</h3>
      <div class="body">
        <div class="search-container">
          <input type="text" class="search-input" placeholder="Search appointments by title, user, or notes..." id="searchInput" onkeyup="filterAppointments()">
        </div>
        <div class="tablewrap">
          <table>
            <thead><tr><th>Title</th><th>Time</th><th>Notes</th><th>Appointment ID</th><th>User</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody>
              {% for a in appointments %}
              <tr data-appt-id="{{ a.id }}">
                <td>{{ a.title }}</td>
                <td class="small">{{ a.time | format_time }}</td>
                <td class="small">{{ a.notes if a.notes else 'N/A' }}</td>
                <td class="small">{{ a.id }}</td>
                <td>
                  <div class="small">{{ a.username if a.username else 'N/A' }}</div>
                </td>
                <td class="small appt-status"><span class="pill">{{ a.status }}</span></td>
                <td>
                  <div class="menu">
                    <button class="menu-btn" aria-haspopup="true" aria-expanded="false" title="Actions">⋮</button>
                    <div class="menu-list">
                      <div class="menu-item" onclick="editAppointment('{{ a.id }}')">✎ Edit</div>
                      <div class="menu-item" onclick="cancelAppt('{{ a.id }}')" style="color:#fca5a5;">✖ Cancel</div>
                    </div>
                  </div>
                </td>
              </tr>
              {% endfor %}
              {% if appointments|length == 0 %}<tr><td colspan="7" class="small">No appointments</td></tr>{% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('click', function(e){
      if(!e.target.closest('.menu')){
        document.querySelectorAll('.menu.open').forEach(function(m){ m.classList.remove('open'); m.querySelector('.menu-btn') && (m.querySelector('.menu-btn').setAttribute('aria-expanded','false')); });
        var ex=document.getElementById('global-menu'); if(ex){ ex.remove(); }
      }
      var btn = e.target.closest('.menu-btn');
      if(btn){ 
        var menu = btn.parentElement; var isOpen = menu.classList.contains('open');
        document.querySelectorAll('.menu.open').forEach(function(m){ if(m!==menu){ m.classList.remove('open'); m.querySelector('.menu-btn') && (m.querySelector('.menu-btn').setAttribute('aria-expanded','false')); }});
        var ex=document.getElementById('global-menu'); if(ex){ ex.remove(); }
        if(!isOpen){
          var list = menu.querySelector('.menu-list');
          if(list){ var fly=document.createElement('div'); fly.id='global-menu'; fly.className='menu-flyout'; fly.innerHTML=list.innerHTML; document.body.appendChild(fly); window.__gmAnchor=btn; function pos(){ var a=window.__gmAnchor; var f=document.getElementById('global-menu'); if(!a||!f) return; var r=a.getBoundingClientRect(); f.style.top=(r.bottom+6)+'px'; var left=Math.min(window.innerWidth - f.offsetWidth - 8, Math.max(8, r.right - f.offsetWidth)); f.style.left=left+'px'; } pos(); window.__gmReposition=function(){ pos(); }; window.addEventListener('resize', window.__gmReposition, { passive:true }); document.addEventListener('scroll', window.__gmReposition, { passive:true, capture:true }); }
        }
        menu.classList.toggle('open', !isOpen); btn.setAttribute('aria-expanded', String(!isOpen));
      }
      var item = e.target.closest('.menu-item');
      if(item){
        if(item.textContent.indexOf('Edit')>-1){ editAppointment(item.getAttribute('data-id')||''); }
        if(item.textContent.indexOf('Cancel')>-1){ cancelAppt(item.getAttribute('data-id')||''); }
        var ex=document.getElementById('global-menu'); if(ex){ ex.remove(); }
        if(window.__gmReposition){ document.removeEventListener('scroll', window.__gmReposition, { capture:true }); window.removeEventListener('resize', window.__gmReposition); window.__gmReposition=null; } window.__gmAnchor=null;
      }
    });
    async function cancelAppt(id){
      if(!id) return; 
      if(!confirm('Cancel this appointment?')) return;
      
      var tokenEl = document.getElementById('auth-token-json');
      const token = tokenEl ? JSON.parse(tokenEl.textContent || '""') : '';
      const username = '{{ username }}';
      
      try{
        const res = await fetch('/cancel_appointment', {
          method:'POST',
          headers:{ 
            'Content-Type':'application/json', 
            'Authorization': token ? ('Bearer '+token) : '' 
          },
          body: JSON.stringify({ 
            appointment_id: id, 
            username: username,
            bot_id: '' // Add bot_id if available
          })
        });
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
        const data = await res.json();
        if(data && data.success){
          const cell = document.querySelector(`tr[data-appt-id="${id}"] .appt-status`);
          if(cell) cell.innerHTML = '<span class="pill">cancelled</span>';
          alert('Appointment cancelled successfully!');
        } else {
          const errorMsg = data && data.error ? data.error : 'Failed to cancel appointment';
          alert(`Error: ${errorMsg}`);
        }
      }catch(e){ 
        console.error('Cancellation error:', e);
        alert(`Network error: ${e.message}`); 
      }
    }
    function editAppointment(id){ alert('Edit placeholder for '+id); }
    
    // Search functionality
    function filterAppointments() {
      const searchInput = document.getElementById('searchInput');
      const searchTerm = searchInput.value.toLowerCase();
      const tableRows = document.querySelectorAll('tbody tr');
      
      tableRows.forEach(row => {
        const title = row.cells[0]?.textContent.toLowerCase() || '';
        const user = row.cells[4]?.textContent.toLowerCase() || '';
        const notes = row.cells[2]?.textContent.toLowerCase() || '';
        const appointmentId = row.cells[3]?.textContent.toLowerCase() || '';
        
        const matches = title.includes(searchTerm) || 
                       user.includes(searchTerm) || 
                       notes.includes(searchTerm) || 
                       appointmentId.includes(searchTerm);
        
        row.style.display = matches ? '' : 'none';
      });
    }
  </script>
  <script type="application/json" id="auth-token-json">{{ (token or '') | tojson | safe }}</script>
</body>
</html>


